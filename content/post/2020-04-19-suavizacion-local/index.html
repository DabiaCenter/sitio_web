---
aliases: [suavizacion-local]
title: 'Funciones de Suavizaci√≥n local aplicadas a datos de violencia dom√©stica'
authors: [bryan]
date: '2020-04-19'
tags: [series-de-tiempo]
output:
  blogdown::html_page:
    toc: true
    number_sections: false
    toc_depth: 1
---



<div style="text-align: justify">

<blockquote>
<p>La conducta humana puede llegar a ser confusa, m√°s cuando se piensa, por ejemplo, en cuestiones como la violencia. ¬øQu√© lleva a una persona a agredir a su pareja sentimental? ¬øPor qu√© hay padres que abusan f√≠sicamente de sus hijos? Actualmente este tema -el de la violencia dom√©stica- ha llamado mucho la atenci√≥n en Costa Rica, debido a la actual pandemia del COVID-19: se prev√© que el confinamiento familiar, mezclado con la ansiedad provocada por la crisis, conduzca a un lamentable aumento en casos de violencia dom√©stica.</p>
</blockquote>
<p>Por otro lado, similar a la conducta humana, <strong>un conjunto de datos puede llegar a ser confuso</strong>. Obs√©rvese el siguiente gr√°fico que representa la cantidad de nuevos casos de violencia dom√©stica al mes que se tramitan en el Poder Judicial.</p>
<p><img src="/post/2020-04-19-suavizacion-local/index_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>Como se observa, estos datos presentan mucho ruido (es decir, mucha variabilidad azarosa, que no guarda relaci√≥n con el tiempo): ¬øQu√© lleva a la variable a tomar estos valores? ¬øC√≥mo saber si los datos tienen tendencia o estacionalidad? ¬øQu√© modelo se podr√≠a escoger para representar -e incluso pronosticar- una serie de datos ‚Äúruidosos‚Äù como esta?</p>
<p><strong>La Suavizaci√≥n es una t√©cnica de an√°lisis de datos que permite detectar patrones de comportamiento en una serie de datos</strong> (entre otras cosas aplicacione), cuando dichos patrones son desconocidos. Esta informaci√≥n es √∫til para seleccionar un modelo (por ejemplo: de regresi√≥n) que describa y pronostique con cierta exactitud el fen√≥meno; de lo contrario y sin Suavizaci√≥n, dicho modelo tendr√≠a escogerse mediante prueba y error.</p>
<p>La Suavizaci√≥n puede clasificarse en dos grupos: Suavizaci√≥n global y Suavizaci√≥n local. <strong>La presente publicaci√≥n se centrar√° en explicar y aplicar las funciones de Suavizaci√≥n local m√°s comunes</strong> en la literatura y la web, las cu√°les son:</p>
<ul>
<li>Media/mediana m√≥vil</li>
<li>Suavizaci√≥n por Kernel o ponderada</li>
<li>Regresi√≥n local ponderada m√≥vil</li>
<li>Suavizaci√≥n por spline</li>
</ul>
<p>Para aplicar estas funciones, se utilizar√°n <strong>datos reales sobre violencia dom√©stica en nuestro pa√≠s</strong>, los cu√°les se extraen directamente de la p√°gina web del Poder Judicial de Costa Rica, disponibles en <a href="http://datosabiertospj.eastus.cloudapp.azure.com/dataset/violencia-domestica">este enlace</a>. Los datos se cargan a continuaci√≥n.</p>
<pre class="r"><code>#Se descargan los datos de la carpeta de trabajo establecida
datos &lt;- as.data.table(read_excel(&quot;PJCROD_VIOLENCIADOMESTICA_V1.xls&quot;)) 

#Significado de cada variable en https://justiciaabierta.poder-judicial.go.cr/index.php?option=com_sppagebuilder&amp;view=page&amp;id=121
#View(datos) 
            
#Son de inter√©s s√≥lo las variables 1, 2 y 10
datos &lt;- datos[, .(Anno, Mes, Entrados)] 

#Se observa que todas las variables son de la clase character
#str(datos)

#Se cambia la variable Entrados a tipo integer y se crea una variable fecha, uni√©ndo las dos primeras
datos[, &#39;:=&#39;(Entrados = as.integer(Entrados), 
             Fecha    = as.yearmon(paste(Anno, Mes), &quot;%Y %m&quot;))] 

#Se agregan los datos de casos nuevos por mes y se crea una cuenta de los meses totales
datos &lt;- datos[, .(Entrados = sum(Entrados)), by = Fecha][, &#39;:=&#39;(Meses = 1:.N)] </code></pre>
<div id="l√©eme" class="section level2">
<h2>¬°L√©eme!</h2>
<p>La clase de objeto de R con el que se almacenar√°n y tratar√°n los datos se llama data.table, un tipo de data.frame mejorado y que presenta m√∫ltiples diferencias en su sintaxis. Si desea aprender sobre data.table y sus ventajas, puede llevar un curso introductorio parcialmente gratuito en <a href="https://www.datacamp.com/courses/data-manipulation-in-r-with-datatable">DataCamp.com</a> .</p>
</div>
<div id="media-m√≥vil" class="section level2">
<h2>Media m√≥vil</h2>
<p>Esta es la funci√≥n suavizadora m√°s conocida, sencilla y f√°cil de interpretar. <strong>Consiste en reemplazar cada observaci√≥n por el promedio de un subconjunto cercano de datos</strong>; debe determinarse el tama√±o del subconjunto y cu√°l observaci√≥n de este ser√° reemplazada por el promedio (si es centrado o no).</p>
<div/>

<center>
<p><span class="math inline">\(M_N=\frac{y_N+y_{N-1}+...+y_2+y_1}{N}= \frac{1}{N} \sum_{i=1}^{N} y_i\)</span></p>
</center>
<div style="text-align: justify">

<p>Esta funci√≥n se basa en el supuesto de que, dentro subconjunto, la variable dependiente obtiene un valor m√°s o menos constante, por lo que no se deber√≠a aplicar media m√≥vil a subconjuntos muy grandes; lo anterior es la raz√≥n por la que <strong>esta funci√≥n un suavizador muy pobre</strong>.</p>
<p>Para los datos en estudio, se aplicar√° una media m√≥vil con <strong>subconjunto N = 3 meses y centrado</strong> (se reemplaza la observaci√≥n de cada mes por la media m√≥vil dicho mes, el anterior y el siguiente). Se utiliza la funci√≥n <em>rollmean()</em>, del paquete <em>data.table</em>.</p>
<pre class="r"><code>subconjunto = 3

datos &lt;- cbind(datos, 
               datos[, .(MediaMovil = c(NA, rollmean(Entrados, k = subconjunto), NA))])

ggplot(datos, mapping = aes(Fecha)) +
  geom_point(aes(y = Entrados)) +
  geom_line(aes(y  = MediaMovil), color = &quot;red&quot;) +
  labs(title       = &quot;Nuevos casos de violencia dom√©stica al mes&quot;,
       subtitle    = &quot;Suavizaci√≥n por media m√≥vil&quot;,
       caption     = &quot;Fuente: Poder Judicial&quot;) + 
  theme_bw()</code></pre>
<p><img src="/post/2020-04-19-suavizacion-local/index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>La curva obtenida a√∫n resulta <strong>muy poco suave</strong>, de manera que <strong>es dif√≠cil apreciar patrones en los datos</strong> m√°s all√° de la evidente tendencia al alza. Aparte de esta desventaja, la media m√≥vil puede ser muy afectada por valores at√≠picos en los datos, siendo la alternativa aplicar <em>Mediana M√≥vil</em>; no obstante, los datos de violencia dom√©stica no parecen presentar este fen√≥meno, por lo que <strong>el resultado con mediana m√≥vil no es mejor</strong>.</p>
<pre class="r"><code>datos &lt;- cbind(datos, 
               datos[, .(MedianaMovil = c(NA, rollmedian(Entrados, k = subconjunto), NA))])

ggplot(datos, mapping = aes(Fecha)) +
  geom_point(aes(y = Entrados)) +
  geom_line(aes(y  = MedianaMovil), color = &quot;red&quot;) +
  labs(title       = &quot;Nuevos casos de violencia dom√©stica al mes&quot;,
       subtitle    = &quot;Suavizaci√≥n por mediana m√≥vil&quot;,
       caption     = &quot;Fuente: Poder Judicial&quot;) + 
  theme_bw()</code></pre>
<p><img src="/post/2020-04-19-suavizacion-local/index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="suavizaci√≥n-por-kernel-o-ponderada" class="section level2">
<h2>Suavizaci√≥n por Kernel o ponderada</h2>
<p>Esta funci√≥n es una versi√≥n mejorada de la media m√≥vil y <strong>consiste en dar a cada observaci√≥n del subconjunto un peso o ponderaci√≥n</strong>, de manera que las observaciones m√°s cercanas al valor a reemplazar -respecto a x- tendr√°n mayor peso en el promedio que aquellas m√°s lejanas, debido a esto <strong>la suavizaci√≥n es mayor</strong>.</p>
<div/>

<center>
<p><span class="math inline">\(\frac{w_N*y_N+w_{N-1}*y_{N-1}+...+w_2*y_2+w_1*y_1}{N}= \frac{1}{N} \sum_{i=1}^{N} w(x_i)y_i\)</span></p>
</center>
<div style="text-align: justify">

<p><strong>Se le llama ‚ÄúKernel‚Äù ya que debe escogerse la distribuci√≥n de probabilidad seg√∫n la cual se asignan los pesos</strong> (o en su defecto, se deben establecer los pesos para cada observaci√≥n del subconjunto); a esto se le llama Kernel, siendo el m√°s usual la Distribuci√≥n Normal (de ah√≠ que algunos llamen a esta funci√≥n <em>Suavizaci√≥n Gaussiana Continua</em>).</p>
<p>Para el ejemplo en cuesti√≥n, se emplea la funci√≥n <em>ksmooth</em>, en la cual se puede especificar en el par√°metro <em>kernel</em> las opciones <em>normal</em> o <em>box</em> (<strong>esta √∫ltima convierte la funci√≥n en suavizaci√≥n por media m√≥vil</strong>). Con <em>ksmooth</em>, los promedios est√°n centrados.</p>
<pre class="r"><code>datos &lt;- cbind(datos, 
               datos[, .(SuavKernel = ksmooth(Meses,
                                              Entrados, 
                                              kernel    = &quot;normal&quot;, 
                                              bandwidth = subconjunto,
                                              n.points  = length(Meses))$y)])

ggplot(datos, mapping = aes(Fecha)) +
  geom_point(aes(y = Entrados)) +
  geom_line(aes(y  = SuavKernel), color = &quot;red&quot;) +
  labs(title       = &quot;Nuevos casos de violencia dom√©stica al mes&quot;,
       subtitle    = &quot;Suavizaci√≥n por kernel&quot;,
       caption     = &quot;Fuente: Poder Judicial&quot;) + 
  theme_bw()</code></pre>
<p><img src="/post/2020-04-19-suavizacion-local/index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
<div id="regresi√≥n-local-ponderada-m√≥vil" class="section level2">
<h2>Regresi√≥n local ponderada m√≥vil</h2>
<p>Se le conoce tambi√©n como L√≠nea m√≥vil, ya que <strong>consiste en aplicar una regresi√≥n lineal a las observaciones del subconjunto m√≥vil</strong> -en lugar del c√°lculo de la media-, de manera que se reemplazan las observaci√≥n por el resultado de evaluar cada valor de X en cada regresi√≥n local.</p>
<p><strong>Con esta funci√≥n es posible considerar subconjuntos m√°s amplios</strong>, lo que resulta en una l√≠nea m√°s suave.</p>
<p>Se dice que la funci√≥n <em>loess()</em> - <em>Locally Weighted Least Squares Regression</em> - <strong>es la funci√≥n m√°s com√∫nmente usada por analistas en R para suavizar datos</strong>, debido a su flexibilidad. Adem√°s, es una funci√≥n ponderada; sin embargo, el Kernel que emplea por defecto es no-param√©trico y se llama <em>Tukey tri-c√∫bico</em>.</p>
<pre class="r"><code>datos &lt;- cbind(datos, 
               datos[, .(Regresion  = loess(Entrados ~ Meses,
                                            degree   = 1)$fitted,
                       RegresionPeq = loess(Entrados ~ Meses, 
                                            degree   = 1,
                                            span     = 0.15)$fitted,
                       RegresionMed = loess(Entrados ~ Meses, 
                                            degree   = 1,
                                            span     = 0.40)$fitted)])

ggplot(datos, mapping = aes(Fecha)) +
  geom_point(aes(y = Entrados)) +
  geom_line(aes(y  = RegresionPeq), color = &quot;red&quot;) +
  labs(title       = &quot;Nuevos casos de violencia dom√©stica al mes&quot;,
       subtitle    = &quot;Suavizaci√≥n por regresi√≥n local&quot;,
       caption     = &quot;Fuente: Poder Judicial&quot;)+ 
  theme_bw()</code></pre>
<p><img src="/post/2020-04-19-suavizacion-local/index_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>La suavizaci√≥n obtenida para los casos de violencia domestica al mes resulta mejor que con las funciones anteriores. Cabe destacar que el par√°metro <em>span</em> recibe <strong>el tama√±o del subconjunto como un porcentaje del total de observaciones</strong> (el tama√±o escogido es arbitrario), de manera que se pueden generar m√∫ltiples suavizaciones.</p>
<pre class="r"><code>ggplot(datos, mapping = aes(Fecha)) +
  geom_point(aes(y = Entrados)) +
  geom_line(aes(y  = RegresionPeq), color = &quot;red&quot;) +
  geom_line(aes(y  = RegresionMed), color = &quot;green&quot;) +
  geom_line(aes(y  = Regresion), color = &quot;blue&quot;) +
  labs(title       = &quot;Nuevos casos de violencia dom√©stica al mes&quot;,
       subtitle    = &quot;Suavizaci√≥n por regresi√≥n local&quot;,
       caption     = &quot;Fuente: Poder Judicial&quot;) + 
  theme_bw() +
  annotate(&quot;text&quot;, x = 2016, y = 4150, label = &quot;subconjunto = 0.75&quot;, color = &quot;blue&quot;) +
  annotate(&quot;text&quot;, x = 2016, y = 4500, label = &quot;subconjunto = 0.40&quot;, color = &quot;green&quot;) +
  annotate(&quot;text&quot;, x = 2016, y = 4850, label = &quot;subconjunto = 0.15&quot;, color = &quot;red&quot;)</code></pre>
<p><img src="/post/2020-04-19-suavizacion-local/index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
</div>
<div id="suavizaci√≥n-por-spline" class="section level2">
<h2>Suavizaci√≥n por spline</h2>
<p>El √∫ltimo m√©todo de suavizaci√≥n es totalmente diferente al resto, ya que combina m√©todos num√©ricos de <em>interpolaci√≥n segmentaria polinomial</em> y el concepto de <em>minimizaci√≥n de curvatura</em>. <strong>Consiste en una funci√≥n polin√≥mica por partes</strong> (usualmente c√∫bica), <strong>definida por una serie de nodos unidos suave y continuamente</strong>. Cada polin√≥mio en la funci√≥n debe cumplir con las siguientes condiciones:</p>
<ul>
<li>Tener 1¬∞ y 2¬∞ derivada, continuas y definidas</li>
<li>Minimizar la suma de cuadrados del error</li>
<li>Minimizar la curvatura</li>
</ul>
<p>La segunda y tercera condici√≥n se combinan en la siguiente definici√≥n matem√°tica:</p>
<div/>

<center>
<p><span class="math inline">\(minimize:\sum_{i=1}^{N} (y_i-g(x_i))^2 + Œª \left(\int_{}^{} g&#39;&#39;(x_i)^2 \; dx\right)\)</span></p>
</center>
<div style="text-align: justify">

<p><strong>Estas condiciones est√°n opuestas entre s√≠</strong>: mientras que la segunda condici√≥n empuja la curva hacia cada dato (<em>ruido</em>), la tercera condici√≥n intenta que la l√≠nea se alise (<em>suavizaci√≥n</em>). El equilibrio entre estas condiciones se obtiene mediante el par√°metro <em>lamda</em>, de manera que el polinomio o ‚Äúspline‚Äù que minimice la expresi√≥n ser√° el escogido.</p>
<p>Cabe enfatizar que se genera un polinomio para cada par de nodos, <strong>por lo que es un suavizador √∫til cuando los datos originales presentan fuertes cambios de tendencia</strong>. Adem√°s, el par√°metro lamda puede optimizarse mediante <em>validaci√≥n cruzada</em>.</p>
<pre class="r"><code>datos &lt;- cbind(datos, 
               datos[, .(SuavSpline = smooth.spline(Meses,
                                                    Entrados,
                                                    cv = TRUE)$y)])

ggplot(datos, mapping = aes(Fecha)) +
  geom_point(aes(y = Entrados)) +
  geom_line(aes(y  = SuavSpline), color = &quot;red&quot;) +
  labs(title       = &quot;Nuevos casos de violencia dom√©stica al mes&quot;,
       subtitle    = &quot;Suavizaci√≥n por spline&quot;,
       caption     = &quot;Fuente: Poder Judicial&quot;) + 
  theme_bw()</code></pre>
<p><img src="/post/2020-04-19-suavizacion-local/index_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>Para el ejemplo sobre violencia dom√©stica, se emplea la funci√≥n <em>smooth.spline</em> -del paquete <em>spline</em>-, indicando con el par√°metro <em>cv = TRUE</em> que debe optimizarse el par√°metro <em>lamda</em> por validaci√≥n cruzada.</p>
</div>
<div id="an√°lisis-y-conclusiones" class="section level2">
<h2>An√°lisis y conclusiones</h2>
<p><strong>Con la Suavizaci√≥n por splines se obtuvo la recta m√°s alisada</strong>, de manera que podemos realizar algunas consideraciones sobre el comportamiento de los datos sobre violencia dom√©stica al mes.</p>
<p>Es evidente que los datos presentan una lamentable tendencia al alza, por lo que una primera aproximaci√≥n podr√≠a hacerse mediante un modelo de <em>regresi√≥n lineal</em>; no obstante, <strong>la recta suavizada podr√≠a semejarse tambi√©n a una curva S</strong>, por lo que podr√≠an modelarse estos datos mediante alg√∫n <em>modelo log√≠stico</em> o de <em>tendencia amortiguada</em>. Un comportamiento log√≠stico, por ejemplo, indicar√≠a que -por alg√∫n motivo a investigarse- <strong>los casos de violencia dom√©stica registran un aumento que se desacelera gradualmente</strong> (como lo muestran los √∫ltimos meses), por lo que -al menos- la tendencia deb√≠a estabilizarse en alg√∫n momento. Si los datos se ajustaran con cierta exactitud a un modelo log√≠stico, ¬øcu√°les ser√≠an los motivos detr√°s del comportamiento descrito?</p>
<p><strong>La recta suavizada tambi√©n aparenta presentar estacionalidad</strong>: al observar su comportamiento, pareciera ocurrir un descenso en la cantidad de casos nuevos en los meses previos a enero de cada a√±o. ¬øHabr√° una causa para esto? Ser√≠a recomendable aplicar la t√©cnica de <em>Descomposici√≥n de series de tiempo</em>, a fin de verificar estos indicios. ¬øQu√© reflexiones podr√≠an realizar funcionarios del Poder Judicial si resulta que dicha estacionalidad es cierta?</p>
<blockquote>
<p>Como se dijo en un principio, tanto los datos y como los fen√≥menos detr√°s de estos pueden ser confusos; a pesar de esto y ante el ejemplo y las funciones desarrolladas, la Suavizaci√≥n se nos presenta como una herramienta muy √∫til para aproximarnos a las respuestas que buscamos‚Ä¶</p>
</blockquote>
</div>
<div id="addendum" class="section level2">
<h2>Addendum</h2>
<p>‚Ä¶pero, eso no es lo √∫nico que se puede decir sobre las t√©cnicas de Suavizaci√≥n. Existe un prop√≥sito a√∫n m√°s interesante, una aplicaci√≥n que a hecho de este concepto uno de los m√°s exitosos m√©todos de an√°lisis de series de tiempo. Se trata de los <strong>Modelos de Pron√≥stico por Suavizaci√≥n Exponencial</strong>. ¬øDeseas enterarte de este tema? No te pierdas la pr√≥xima publicaci√≥n de este servidor üòâ.</p>
</div>
<div id="referencias" class="section level2">
<h2>Referencias</h2>
<p>Irizarry, A. R.(2019). <a href="https://rafalab.github.io/dsbook/"><em>Introduction to Data Science: Data Analysis and Prediction Algorithms with R</em></a>.</p>
<p>Chan, C. (2018). <a href="https://www.r-bloggers.com/smoothing-time-series-data/"><em>Smoothing Time Series Data</em></a>.</p>
<p>Jennings, C. L., Kulahci, M., &amp; Montgomery, D. C. (2014). <em>Introduction to time series analysis and forecasting</em>, Wiley-Blackwell.</p>
<p>Singh, W. A. (30 de junio, 2017). <a href="https://www.centerspace.net/smoothing-cubic-splines"><em>Cubic and Smoothing Splines in R</em></a></p>
</div>
